---
title: "Spatial relationships between CD8+ T cells and Tregs"
author: "Joel Eliason"
date: "12/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spatstat)
library(glue)
library(spatialOnco)
```

### Questions/Analyses

  1. Are there differences in the spatial relationships of CD8+ T cells and Tregs between patient groups? Patient stage?
  2. Is there any significant interaction of immune cells and vasculature in either patient group?
  3. At what spatial scale do we observe spatial relationships of CD8+ T cells and Tregs?
  
  
#### Data IO/preprocessing

```{r}
DATA_PATH = '../data/nbhd_coord_schurch_2020/'
df = read_csv(glue('{DATA_PATH}CRC_master.csv'))
pt_data = readxl::read_excel(glue('{DATA_PATH}CRC_TMAs_patient_annotations.xlsx'))

```

```{r}
df %>%
  group_by(spots,ClusterName) %>%
  filter(ClusterName == 'Tregs' | ClusterName == 'CD8+ T cells') %>%
  summarise(n())
  
```
From this we will choose spot 15_B (almost equal ratio of Tregs and CD8+ T cells) and 20_A (more than twice as many CD8+ T cells than Tregs). Spot 15B corresponds to patient 8, who is in group 2 (DII), while 20A corresponds to patient 10, who is in group 1 (CLR).

```{r}
spot_eq = df %>%
  filter(spots == '15_B')

spot_un = df %>%
  filter(spots == '20_A')
```

We can then create the spatial point processes for both spots as well:

```{r}
create_ppp = function(df,cell_types=c('Tregs','CD8+ T cells')) {
  Xmin = min(df$X) - 5
  Xmax = max(df$X) + 5
  Ymin = min(df$Y) - 5
  Ymax = max(df$Y) + 5
  
  filt = df %>%
    filter(ClusterName %in% cell_types) %>%
    mutate(ClusterName = factor(ClusterName))
  
  pat = ppp(filt$X,filt$Y,c(Xmin,Xmax),c(Ymin,Ymax))
  
  marks(pat) <- filt$ClusterName
  
  return(pat)
}

pat_eq = create_ppp(spot_eq)
pat_un = create_ppp(spot_un)

pat_un
```


### Initial visualizations

```{r}
plot(pat_eq)
plot(pat_un)
```
Quadrant counts

```{r}
plot(quadratcount(split(pat_eq)))
plot(quadratcount(split(pat_un)))

```

```{r}
quadrat.test(pat_eq,3,3)
```

```{r}
plot(density(split(pat_eq)))
plot(density(split(pat_un)))
```

```{r}
miplot(pat_eq)
sapply(split(pat_eq), miplot)
```
Greater than 1 indicates clustering - so we are seeing clustering at all spatial scales in the equal pattern.

```{r}
miplot(pat_un)
sapply(split(pat_un), miplot)
```

Looks like there is still clustering at all scales, but to a lesser degree, in the unequal pattern (lower Morisita index).

```{r}
lest_eq = Lest(pat_eq, correction = "good")
plot(lest_eq)

```


```{r}
lest_un = Lest(pat_un, correction = "good")
plot(lest_un)

```


```{r}
kcross_un = Kcross.inhom(pat_un, 'CD8+ T cells', 'Tregs')
kcross_eq = Kcross.inhom(pat_eq, 'CD8+ T cells', 'Tregs')

plot(kcross_un)
plot(kcross_eq)
```

```{r}
plot(pcf(kcross_un))
plot(pcf(kcross_eq))
```

```{r}
tab_un = marktable(pat_un, N=1, collapse = TRUE)

prop.table(tab_un, 1)

tab_eq = marktable(pat_eq, N=1, collapse = TRUE)

prop.table(tab_eq, 1)
```

```{r}
E_un <- envelope(pat_un, function(X,...) {pcf(Kcross.inhom(X,...))}, nsim = 9, nrank = 1, fix.n = TRUE, global = TRUE,'CD8+ T cells', 'Tregs')
plot(E_un)
```

## Model fitting

### Multitype Poisson models

Let's first focus on fitting models for the spot that has equal numbers of CD8+ T cells and Tregs:

```{r}
pat = pat_eq
m.1 = ppm(pat ~ 1)
m.2 = ppm(pat ~ marks)
m.4 = ppm(pat ~ marks * polynom(x,y,1))
m.5 = ppm(pat ~ marks * harmonic(x,y,2))
m.6 = ppm(pat ~ marks * polynom(x,y,3))
m.7 = ppm(pat ~ marks * polynom(x,y,4))

anova(m.1,m.2,m.4,m.5,m.6,m.7,test = "LR")

m.8 = ppm(pat ~ harmonic(x,y,2))

anova(m.8,m.5,test = "LR")

summary(m.5)

confint(m.5)

m.9 = ppm(pat ~ marks + harmonic(x,y,2))

anova(m.9,m.5,test = "LR")
anova(m.1,m.5, test = "LR")

m.best = m.5 # by LR test. Actually the 5 degree polynomial is the best, but I think we are just missing some covariates.

plot(relrisk(m.best,casecontrol = F))
plot(pat)
```

### Exploring dependency between kinds of points

```{r}
pat = pat_eq
marktable(pat,N=2,collapse = T) # also markstats, applynbd
nncorr(pat) # probability that nearest neighbor is of the same type

plot(alltypes(pat, markconnect))
```

```{r}
plot(alltypes(pat,Gcross))
```

#### Model diagnostics

```{r}
diagnose.ppm(m.best, which = "marks")
compareFit(list(m.5,m.9))

plot(Kres(m.best))
```

```{r}
m_2 = ppm(pat ~ marks*polynom(x,y,2),MultiHard())

AIC(m_2)
```

