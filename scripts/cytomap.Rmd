---
title: "CytoMAP - extensions and replications"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spatgraphs)
library(spatialOnco)
library(bluster)
library(pheatmap)
```

#### Data IO/preprocessing

```{r}
DATA_PATH = '../data/nbhd_coord_schurch_2020/'
df = read_csv(paste0(DATA_PATH,'CRC_master.csv'))
pt_data = readxl::read_excel(paste0(DATA_PATH,'CRC_TMAs_patient_annotations.xlsx'))

```

```{r}
spot_eq = df %>%
  filter(spots == '15_B')
pat_eq = create_ppp(spot_eq$X,spot_eq$Y,spot_eq$ClusterName,
                    keep_types =c('Tregs','CD8+ T cells','vasculature','tumor cells'))
```

CytoMAP functionality to replicate:

1. cell type definition (passing on this for now, lots of examples)
2. Neighborhood definition (raster-scan vs graph based)
3. Neighborhood clustering (many ways of calculating neighborhood similarities)
  * Straight forward clusterings first...
  * diagnostics on clusterings
  * Then things like graph embeddings
4. cell type correlations
5. distance to border or other landmark (may pass on this as well)
6. pseudospace
7. region visualization and statistics


### Neighborhoods

Ideally, we'd like to input a neighborhood type (w/ parameters) and point pattern, and get a list of neighborhoods out.

```{r}
sg_eq = spatgraph(pat_eq,type="SIG")
plot(sg_eq,pat_eq)

nbhds = sg_to_nbhds(sg_eq,pat_eq)
nbhds

```

Scaling neighborhood composition:

1. comp (default) - divide by total number of cells, yields local composition of cell types
2. global.comp - divide by maximum number of cells across all neighborhoods per cell type, normalizes
each cell type to its own maximum
3. binary - 1 if cell type is present, 0 otherwise
4. standardize - normalizes so that cell types have mean 0 and standard deviation of 1

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "standardize")
```

```{r}
celltype_heatmap(nbhds.obj)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "standardize")
centroids = cluster_nbhds(nbhds.obj,scaled=T)
nbhd_celltype_heatmap(centroids)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "comp")
centroids = cluster_nbhds(nbhds.obj,scaled=T)
nbhd_celltype_heatmap(centroids)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "global.comp")
centroids = cluster_nbhds(nbhds.obj,scaled=T)
nbhd_celltype_heatmap(centroids)
```

Global.comp and standardize are very similar - makes sense, since they both standardize globally (using the max).
comp is different, since it is taking into account only the local composition.