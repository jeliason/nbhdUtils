---
title: "EDA of cell types and biomarkers"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(PCAtools)
library(pheatmap)
DATA_PATH = '../data/nbhd_coord_schurch_2020/'
df = read_csv(paste0(DATA_PATH,'CRC_master.csv'))

d = df %>% select(X,Y,`CD44 - stroma`:`MMP12 - matrix metalloproteinase`,spots) %>%
  filter(spots == '15_A') %>%
  select(-spots)

MIN_DIST = 25

xy = d %>%
  dplyr::select(c(X,Y)) %>%
  rename(x = X,y=Y) %>%
  as.data.frame

set.seed(2022); xy = spatialRF::thinning(xy,minimum.distance = MIN_DIST)

d = d %>%
  semi_join(.,xy,by=c("X"="x","Y"="y")) %>%
  mutate(obs = 1:nrow(.)) %>%
  select(-c(X,Y)) %>%
  rename_with(~sub(" .*", "", .x)) %>%
  rename_with(~sub("-",".",.x)) %>%
  select(-obs)


col.rel.nb <- spdep::graph2nb(spdep::relativeneigh(as.matrix(xy)), sym=TRUE)

C = spdep::nb2mat(col.rel.nb,style="B",zero.policy=T)
listw = spdep::mat2listw(C)
```

```{r}
library(caret)
apply(d,2,var)

p <- pca(d, center = T, scale = T)

biplot(p, showLoadings = TRUE, lab = NULL)

screeplot(p, axisLabSize = 18, titleLabSize = 22)

loadings(p)

p$rotated

plotloadings(p)

eigencorplot(p,metavars = c("CD44","FOXP3"))

colnames(d)

pc1 <- p$loadings[,1]

boxplot(pc1)

summary(pc1)


```

Prevalence in tumor cells

```{r}
d1 = df %>% select(X,Y,`CD44 - stroma`:`MMP12 - matrix metalloproteinase`,spots,ClusterName) %>%
  filter(spots == '15_A') %>%
  select(-spots) %>%
  rename(type = ClusterName)
range01 <- function(x){(x-min(x))/(max(x)-min(x))}

d1 %>%
  mutate(across(-type,.fns=~range01(.))) %>%
  filter(type == "tumor cells") %>%
  select(-c(type,X,Y)) %>%
  colMeans %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  as_tibble %>%
  rename(.,val = `.`) %>%
  filter(val >= 0.15) %>%
  ggplot(aes(x=rowname,y=val)) + 
  geom_col() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

d1 %>%
  mutate(across(-type,.fns=~range01(.))) %>%
  filter(type == "tumor cells") %>%
  select(-c(type,X,Y)) %>%
  colMeans %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  as_tibble %>%
  rename(.,val = `.`) %>%
  filter(val >= 0.15) %>%
  pull(rowname)
```
 markers to study
 
beta-catenin
PD-1
EGFR
p53
MMP12

Macrophages:

T cells:

Granulocytes:

Tregs

B cells

NK cells

Monocytes


```{r}
library(magrittr)
library(spatialOnco)
spot.labels = c("15_A")
keep_types = unique(df$ClusterName)

nbhds = make_spot_nbhds(df,spot.labels,keep_types, radius = 50)

df %>%
  filter(spots == "15_A") %$%
  table(ClusterName)
```

B cells
CD4+ T cells CD45RO+
CD68+ macrophages
CD68+CD163+ macrophages
CD8+ T cells
granulocytes
Tregs

```{r}
library(spdep)
table(card(col.rel.nb))

relativeneigh(as.matrix(xy))

plot(col.rel.nb,xy)

col.rel.nb[[1]]

library(geometry)

polyarea(xy$x[c(1,col.rel.nb[[1]])],xy$y[c(1,col.rel.nb[[1]])])

c.hull = chull(cbind(xy$x[c(1,col.rel.nb[[1]])],xy$y[c(1,col.rel.nb[[1]])]))


nbareas <- function(nb,xy) {
  sapply(1:length(nb),function(i) {
    idx <- c(i,nb[[i]])
    c.hull = chull(xy$x[idx],xy$y[idx])
    polyarea(xy$x[idx[c.hull]],xy$y[idx[c.hull]])
  })
}

nb.ar <- nbareas(col.rel.nb,xy)

nb.ar

col.rel.nb[[1]]

cmarks = df %>%
  filter(spots == "15_A") %>%
  pull(ClusterName)
marks = levels(as.factor(df$ClusterName))
nbhds = sapply(1:length(col.rel.nb),function(i) {
    x = c(cmarks[i],cmarks[col.rel.nb[[i]]])
    x = factor(x,levels=marks)
    as.vector(table(x))
  })
nbhds = t(nbhds)
colnames(nbhds) = marks
nbhds

dens <- sweep(nbhds,1,nb.ar,"/")

dens %>%
  as_tibble

markers = df %>%
  filter(spots == "15_A") %>%
  select((contains("beta-catenin") | contains("PD-1") | contains("EGFR") | contains("p53") | contains("MMP12")) & !contains("+")) %>%
  mutate(across(.fns=range01))
mean_markers = sapply(1:length(col.rel.nb),function(i) { 
  x = markers %>% slice(c(i,col.rel.nb[[i]])) %>% summarise(across(.fns=mean))
  list(x)
})
mean_markers
```




