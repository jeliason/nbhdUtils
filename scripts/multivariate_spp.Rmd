---
title: "Multivariate spatial relationships"
author: "Joel Eliason"
date: "12/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spatstat)
library(glue)
```

### Questions/Analyses

  1. Exploration of multivariate summary statistics and null models to examine community structure.
  
  
#### Data IO/preprocessing

```{r}
DATA_PATH = '../data/nbhd_coord_schurch_2020/'
df = read_csv(glue('{DATA_PATH}CRC_master.csv'))
pt_data = readxl::read_excel(glue('{DATA_PATH}CRC_TMAs_patient_annotations.xlsx'))

```

```{r}
df %>%
  group_by(spots,ClusterName) %>%
  filter(ClusterName == 'Tregs' | ClusterName == 'CD8+ T cells' | ClusterName == 'vasculature' | ClusterName == 'tumor cells') %>%
  summarise(n())
  
```
From this we will choose spot 15_B (almost equal ratio of Tregs and CD8+ T cells) and 20_A (more than twice as many CD8+ T cells than Tregs). Spot 15B corresponds to patient 8, who is in group 2 (DII), while 20A corresponds to patient 10, who is in group 1 (CLR).

```{r}
spot = df %>%
  filter(spots == '15_B')
```

We can then create the spatial point processes for both spots as well:

```{r}
create_ppp = function(df,cell_types=c('Tregs','CD8+ T cells','vasculature','tumor cells')) {
  Xmin = min(df$X) - 5
  Xmax = max(df$X) + 5
  Ymin = min(df$Y) - 5
  Ymax = max(df$Y) + 5
  
  filt = df %>%
    filter(ClusterName %in% cell_types) %>%
    mutate(ClusterName = factor(ClusterName))
  
  pat = ppp(filt$X,filt$Y,c(Xmin,Xmax),c(Ymin,Ymax))
  
  marks(pat) <- filt$ClusterName
  
  return(pat)
}

pat = create_ppp(spot)

pat
```


### Initial visualizations

```{r}
plot(pat)
```

```{r}
miplot(pat)
sapply(split(pat), miplot)
```
Greater than 1 indicates clustering - so we are seeing clustering at all spatial scales in this pattern.


```{r}
lest = Lest(pat, correction = "good")
plot(lest)

```


```{r}
kcross = Kcross.inhom(pat, 'tumor cells', 'Tregs')

plot(kcross)
```

```{r}
plot(pcf(kcross))
```

```{r}
tab = marktable(pat, N=1, collapse = TRUE)

prop.table(tab, 1)
```

```{r}
# E <- envelope(pat, function(X,...) {pcf(Kcross.inhom(X,...))}, nsim = 9, nrank = 1, fix.n = TRUE, global = TRUE,'CD8+ T cells', 'Tregs')
# plot(E)
```

### Model fitting

```{r}
m = ppm(pat ~ marks, MultiHard())

plot(fitin(m))

fitin(m)

plot(alltypes(pat, Kcross.inhom))
```

```{r}
library(PenGE)
```

