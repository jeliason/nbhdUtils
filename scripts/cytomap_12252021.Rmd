---
title: "CytoMAP - extensions and replications"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spatgraphs)
library(spatialOnco)
library(bluster)
library(pheatmap)
library(ggnewscale)
library(GGally)
library(brms)
library(lme4)
library(DHARMa)
library(bayesplot)

DATA_PATH = '../data/nbhd_coord_schurch_2020/'
RESULTS_PATH = '../results/cytomap_12252021/'
dir.create(RESULTS_PATH)
df = read_csv(paste0(DATA_PATH,'CRC_master.csv'))
pt_data = readxl::read_excel(paste0(DATA_PATH,'CRC_TMAs_patient_annotations.xlsx'))
```

#### Data IO/preprocessing


```{r}
spot_eq = df %>%
  filter(spots == '15_A') %>%
  select(-`...1`)
keep_types = unique(spot_eq$ClusterName)
# keep_types = keep_types[keep_types != "granulocytes"]
pat = create_ppp(spot_eq$X,spot_eq$Y,spot_eq$ClusterName,
                    keep_types = keep_types)
```

CytoMAP functionality to replicate:

1. cell type definition (passing on this for now, lots of examples)
2. Neighborhood definition (raster-scan vs graph based)
3. Neighborhood clustering (many ways of calculating neighborhood similarities)
  * Straight forward clusterings first...
  * diagnostics on clusterings
  * Then things like graph embeddings
4. cell type correlations
5. distance to border or other landmark (may pass on this as well)
6. pseudospace
7. region visualization and statistics


### Write to file in programita format

```{r}
colnames(spot_eq)
spot = spot_eq
to_programita = function(spot) {
  feats = spot %>%
    dplyr::select(-c("CellID","patients","spots","groups","X","Y","Z")) %>%
    mutate_at(vars(-ClusterName), ~(scale(.) %>% as.vector)) %>%
    group_by(ClusterName) %>%
    summarise(across(where(is.numeric), ~mean(.x, na.rm = TRUE))) %>%
    dplyr::select(where(~!any(is.na(.)))) %>%
    t
  colnames(feats) = feats[1,]
  feats = feats[-1,]
  feats = apply(feats,2,as.numeric)
  dists=as.matrix(stats::dist(t(feats)),labels=T)
  colnames(dists) <- rownames(dists) <- colnames(feats)
}
```


### Neighborhoods

Ideally, we'd like to input a neighborhood type (w/ parameters) and point pattern, and get a list of neighborhoods out.

Furthermore, we should be able to specify a range of graph types, BLUSPARAMS and neighborhood scalings, and be able to see their 
```{r}
sg = spatgraph(pat,type="gabriel",par=NULL)
plot(sg,pat)

nbhds = sg_to_nbhds(sg,pat)

```

Scaling neighborhood composition:

1. comp (default) - divide by total number of cells, yields local composition of cell types
2. global.comp - divide by maximum number of cells across all neighborhoods per cell type, normalizes
each cell type to its own maximum
3. binary - 1 if cell type is present, 0 otherwise
4. standardize - normalizes so that cell types have mean 0 and standard deviation of 1

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "standardize")
```

```{r}
celltype_heatmap(nbhds.obj)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "standardize")
clust.out = cluster_nbhds(nbhds.obj=nbhds.obj)
centroids = clust.out$centroids
nbhd_celltype_heatmap(centroids)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "comp")
clust.out = cluster_nbhds(nbhds.obj=nbhds.obj)
centroids = clust.out$centroids
nbhd_celltype_heatmap(centroids)
```

```{r}
nbhds.obj = scale_nbhds(nbhds,scale = "global.comp")
clust.out = cluster_nbhds(nbhds.obj=nbhds.obj)
centroids = clust.out$centroids
nbhd_celltype_heatmap(centroids)
```

Global.comp and standardize are very similar - makes sense, since they both standardize globally (using the max).
comp is different, since it is taking into account only the local composition.

### Geometric vs raster vs RNG

```{r}
clust.out.geom = cluster_nbhds(pat=pat,ntype = "geometric",par=50L, blusparam = SomParam(centers=5L))
nbhd_celltype_heatmap(clust.out.geom$centroids)
```

```{r}
clust.out.raster = cluster_nbhds(pat=pat,ntype = "raster",par=50L, blusparam = SomParam(centers=5L))
nbhd_celltype_heatmap(clust.out.raster$centroids)
```

```{r}
clust.out.SIG = cluster_nbhds(pat=pat,ntype = "SIG", blusparam = SomParam(centers=5L))
nbhd_celltype_heatmap(clust.out.SIG$centroids)
```


```{r}
linked <- linkClusters(
    list(
        c1=clust.out.SIG$clusters,
        c2=clust.out.geom$clusters
    )
)

meta <- igraph::cluster_walktrap(linked)
plot(linked, mark.groups=meta)
```


### Combining to quickly evaluate clusterings

1. Edge definitions
2. Neighborhood scaling
3. clustering parameters
  3.1 type of clustering
  3.2 parameters per type of clustering


```{r}
# out = nbhdClusterSweep(pat, scales = c("comp"))
# saveRDS(out,paste0(RESULTS_PATH,'out.nbhdClusterSweep_15A.rds'))
out = readRDS(paste0(RESULTS_PATH,'out.nbhdClusterSweep_15A.rds'))
aris = out$aris

pheatmap(aris)
out$medoids



# s = out$medoids[1]
# 
# spl=stringr::str_split(s,"_")[[1]]
# 
# 
# 
# spl2=stringr::str_split(spl[1],stringr::coll("."))[[1]]
# 
# spl2
# 
# setNames(list(spl2[2]),c(spl2[1]))
```

So we have three "representative" clusterings. Let's see if/how they affect downstream results.

```{r}
c1 = cluster_nbhds(pat,ntype="SIG",scale="comp",blusparam = SomParam(centers=5))
c2 = cluster_nbhds(pat,ntype="gabriel",scale="comp",blusparam = SomParam(centers=5))
c3 = cluster_nbhds(pat,ntype="SIG",scale="comp",blusparam = SomParam(centers=9))
```

```{r}
linked <- linkClusters(
    list(
        c1=c1$clusters,
        c2=c2$clusters,
        c3=c3$clusters
    )
)
meta <- igraph::cluster_walktrap(linked)
plot(linked, mark.groups=meta)
```

```{r}
m = linkClustersMatrix(c1$clusters,c2$clusters)

m
```

```{r}
nbhd_celltype_heatmap(c1$centroids)
nbhd_celltype_heatmap(c2$centroids)
nbhd_celltype_heatmap(c3$centroids)

```

```{r}
region_spatial_plot(c1,pat)
```

```{r}
c2 = cluster_nbhds(pat,ntype="geometric",par=50L,scale="comp",blusparam = SomParam(centers=5))

region_spatial_plot(c2,pat)
```


TODO: reorder levels of region so that graphs look similar, automatically or user-defined

These two clusterings look pretty similar to me. Some small discrepancies, but nothing very interesting here.

### Pseudospace analysis

```{r}
sg = spatgraph(pat,type="geometric",par=50)

nbhds = sg_to_nbhds(sg,pat)
nbhds.obj = scale_nbhds(nbhds,scale = "comp")

clust = cluster_nbhds(pat,nbhds.obj,blusparam = SomParam(centers=5))

region_spatial_plot(clust,pat)

cell_types = c('CD68+CD163+ macrophages',"CD8+ T cells","Tregs","tumor cells","vasculature")
pseudospace_plot(nbhds.obj, clusters = clust$clusters,
                 against = "CD8+ T cells",
                 cell_types = cell_types)


celltype_pairsplot(nbhds.obj, clust$clusters, cell_types = cell_types)
```
