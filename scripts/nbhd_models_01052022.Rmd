---
title: "Neighborhood models"
output:
  html_document:
    df_print: paged
---

```{r setup}
library(tidyverse)
library(spatgraphs)
library(brms)
library(spatialOnco)
library(lme4)
library(DHARMa)

DATA_PATH = '../data/nbhd_coord_schurch_2020/'
RESULTS_PATH = '../results/nbhd_models_01052022/'
df = read_csv(paste0(DATA_PATH,'CRC_master.csv'))

spot_eq = df %>%
  filter(spots == '15_B') %>%
  select(-`...1`)
pat = create_ppp(spot_eq$X,spot_eq$Y,spot_eq$ClusterName,
                    keep_types = "all")
sg = spatgraph(pat,type="geometric",par=50)

nbhds = sg_to_nbhds(sg,pat)
nbhds.obj = scale_nbhds(nbhds,scale = "comp")

d = nbhds.obj$scaled_nbhds %>% as_tibble() 
names(d) <- make.names(colnames(d))
```

### Zero-one inflated beta regression vs OLS
#### To predict tumor cell proportions based on proportions of other cells

```{r }
fit.1 <- brm(
  formula = bf(
    tumor.cells ~ 1 + CD8..T.cells + Tregs + vasculature,
    phi ~ 1 + CD8..T.cells + Tregs + vasculature,
    zoi ~ 1 + CD8..T.cells + Tregs + vasculature,
    coi ~ 1 + CD8..T.cells + Tregs + vasculature
  ),
  family = zero_one_inflated_beta(),
  data = d,
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.1")
) %>% add_criterion("loo")
fit.2 <- brm(
  formula = bf(
    tumor.cells ~ 1 + CD8..T.cells + Tregs + vasculature,
    phi ~ 1 + CD8..T.cells + Tregs + vasculature,
    zoi ~ 1 + CD8..T.cells + Tregs + vasculature,
    coi ~ 1 + CD8..T.cells + Tregs + vasculature
  ),
  family = zero_one_inflated_beta(),
  data = d,
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.2")
) %>% add_criterion("loo")
fit.3 <- brm(
  formula = bf(
    tumor.cells ~ 1 + CD8..T.cells + Tregs + vasculature
  ),
  family = gaussian(),
  data = d,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.3")
) %>% add_criterion("loo")
fit.4 <- brm(
  formula = bf(
    tumor.cells ~ 1 + CD8..T.cells + Tregs + vasculature,
    phi ~ 1 + CD8..T.cells + Tregs + vasculature,
    zoi ~ 1 + CD8..T.cells + Tregs + vasculature,
    coi ~ 1
  ),
  family = zero_one_inflated_beta(),
  data = d,
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.4")
) %>% add_criterion("loo")
fit.5 <- brm(
  formula = bf(
    tumor.cells ~ 1 + CD8..T.cells + Tregs + vasculature
  ),
  family = gaussian(),
  data = d,
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.5")
) %>% add_criterion("loo")

fit.6 <- brm(
  formula = bf(
    tumor.cells ~ (CD8..T.cells + Tregs + vasculature)^2
  ),
  family = gaussian(),
  data = d,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.6")
) %>% add_criterion("loo")

fit.7 <- brm(
  formula = bf(
    tumor.cells ~ poly(CD8..T.cells, Tregs, vasculature, degree = 2, raw = TRUE)
  ),
  family = gaussian(),
  data = d,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.7")
) %>% add_criterion("loo")

fit.8 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = gaussian(),
  data = d,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.8")
) %>% add_criterion("loo")

loo_compare(fit.1,fit.2,fit.3,fit.4,fit.5,fit.6,fit.7,fit.8)
```

### Trying out count models as well
```{r}
d.raw = nbhds.obj$nbhds %>% as_tibble()
names(d.raw) <- make.names(colnames(d.raw))

fit.9 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = gaussian(),
  data = d.raw,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.9")
) %>% add_criterion("loo")

fit.10 <- brm(
  formula = bf(
    tumor.cells ~ CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma
  ),
  family = gaussian(),
  data = d.raw,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.10")
) %>% add_criterion("loo")

fit.11 <- brm(
  formula = bf(
    tumor.cells ~ (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma)^2
  ),
  family = gaussian(),
  data = d.raw,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.11")
) %>% add_criterion("loo")

fit.12 <- brm(
  formula = bf(
    tumor.cells ~ CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma
  ),
  family = poisson(),
  data = d.raw,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.12")
) %>% add_criterion("loo")

fit.13 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = poisson(),
  data = d.raw,
  prior = prior(lasso()),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.13")
) %>% add_criterion("loo")

fit.14 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = zero_inflated_poisson(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.14")
) %>% add_criterion("loo")

fit.15 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = negbinomial(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.15")
) %>% add_criterion("loo")

fit.16 <- brm(
  formula = bf(
    tumor.cells ~ .
  ),
  family = zero_inflated_negbinomial(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.16")
) %>% add_criterion("loo")

fit.17 <- brm(
  formula = bf(
    tumor.cells ~ CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells
  ),
  family = negbinomial(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.17")
) %>% add_criterion("loo")

fit.18 <- brm(
  formula = bf(
    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells)^2
  ),
  family = negbinomial(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.18")
) %>% add_criterion("loo")

d.raw.obs = d.raw %>%
  mutate(obs = 1:nrow(.))

fit.19 <- brm(
  formula = bf(
    tumor.cells ~ . - obs + (1 | obs)
  ),
  family = poisson(),
  data = d.raw.obs,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  save_pars = save_pars(all = TRUE),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.19")
) %>% add_criterion("loo")

fit.20 <- brm(
  formula = bf(
    tumor.cells ~ CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + stroma + plasma.cells - obs + (1 | obs)
  ),
  family = poisson(),
  data = d.raw.obs,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  save_pars = save_pars(all = TRUE),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.20")
) %>% add_criterion("loo")

fit.21 <- brm(
  formula = bf(
    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells)^2
  ),
  family = poisson(),
  data = d.raw,
  prior = prior(horseshoe()),
  control = list(adapt_delta = 0.99),
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.21")
) %>% add_criterion("loo")


loo_compare(fit.9,fit.10,fit.11,fit.12,fit.13,fit.14,fit.15,fit.16,fit.17,fit.18,fit.19,fit.20,fit.21)
```

Not seeing any evidence of interactions in predicting tumor cells in neighborhoods for scaled (though need to figure out how to make design matrix not rank-deficient)

In raw nbhds, found possible evidence of CD68.CD163..macrophages:stroma interaction for predicting tumor cells - may need further analysis in Gaussian model

In negative binomial with important interactions, not seeing any evidence of interactions.


```{r}
nbhds = make_spot_nbhds(df,spot.labels = c("15_A","15_B","16_A","16_B"),keep_types = unique(df$ClusterName))
nbhds = nbhds %>% mutate(obs = 1:nrow(.))

fit.2.1 <- run_model(fit.model = glmer,
                     file = paste0(RESULTS_PATH,"fit.2.1"),
                     tumor.cells ~ 1 + CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature +
                       CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells +(1|spot), 
                     family = poisson(),data = nbhds)


fit.2.2 <- run_model(fit.model = glmer.nb,
                     file = paste0(RESULTS_PATH,"fit.2.2"),
                     tumor.cells ~ 1 + CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells +(1|spot),
                     data = nbhds)
```


```{r}
simulationOutput <- simulateResiduals(fittedModel = fit.2.1, plot = F)
plot(simulationOutput)
```

```{r}
plotResiduals(fit.2.1, form = nbhds$CD4..T.cells.CD45RO.)
plotResiduals(fit.2.1, form = nbhds$CD8..T.cells)
plotResiduals(fit.2.1, form = nbhds$Tregs)
plotResiduals(fit.2.1, form = nbhds$CD68.CD163..macrophages)
plotResiduals(fit.2.1, form = nbhds$CD11b.CD68..macrophages)

```

### Try random forest

```{r}
fit.3.1 = run_model(fit.model = randomForest::randomForest,
                    file = paste0(RESULTS_PATH,"fit.3.1"),
                    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells + spot)^2,
                    data = nbhds)

fit.3.1$importance

# ypred.3.1 = predict(fit.3.1, data=nbhds)
# 
# sqrt(sum((ypred.3.1 - nbhds$tumor.cells)^2))

fit.3.2 = run_model(lm,
                    file = paste0(RESULTS_PATH,"fit.3.2"),
                    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells + spot)^2,
                    data = nbhds)

ypred.3.2 = predict(fit.3.2)

sqrt(sum((ypred.3.2 - nbhds$tumor.cells)^2))


fit.3.3 = run_model(glm,
                    file = paste0(RESULTS_PATH,"fit.3.3"),
                    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells + spot)^2,
                    family = poisson(),
                    data = nbhds)

ypred.3.3 = predict(fit.3.3)

sqrt(sum((ypred.3.3 - nbhds$tumor.cells)^2))


d = model.frame(tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells + spot), data = nbhds)

fit.3.4 <- run_model(iRF::iRF,
           file = paste0(RESULTS_PATH,"fit.3.4"),
           x=d[,2:ncol(d)], 
           y=d[,1], 
           n.iter=5, 
           n.core=-1,
           n.bootstrap=10,
           int.return=5
        )

fit.3.4$interaction %>%
  arrange(desc(prevalence))

fit.3.4$weights
```

#### Linear model diagnostics

```{r}
summary(fit.3.2)

olsrr::ols_plot_resid_qq(fit.3.2)
olsrr::ols_plot_resid_fit(fit.3.2)
olsrr::ols_plot_resid_hist(fit.3.2)
```

Not great. Let's go back to a zero-inflated negative binomial.

```{r}
fit.4.1 <- brm(
  formula = bf(
    tumor.cells ~ 1 + (CD4..T.cells.CD45RO. + CD68.CD163..macrophages + CD8..T.cells + Tregs + vasculature + CD11b.CD68..macrophages + CD68..macrophages + stroma + plasma.cells+spot)^2
  ),
  family = negbinomial(),
  data = nbhds,
  prior = prior(horseshoe()),
  # control = list(adapt_delta = 0.99),
  iter = 1100,
  warmup = 1000,
  cores = 4,
  file = paste0(RESULTS_PATH,"fit.4.1")
) %>% add_criterion("loo")
```

```{r}
summary(fit.4.1)
```

Try glmnet for negative binomial. Try only top k interactions as discovered by random forest. Try bayesian discovery of pairwise interactions (Tamara Broderick).

Also need to think more about dependence between neighborhoods. - spatial correlation.

Check spatial autocorrelation in residuals after using GWR model. e.g. Moran's I.

Hypothesis generating vs confirming.